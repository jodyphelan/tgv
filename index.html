<html>
    <head>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.23.0/cytoscape.min.js" integrity="sha512-gEWKnYYa1/1c3jOuT9PR7NxiVI1bwn02DeJGsl+lMVQ1fWMNvtjkjxIApTdbJ/wcDjQmbf+McWahXwipdC9bGA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
        <script src="https://unpkg.com/dropzone@5/dist/min/dropzone.min.js"></script>
        <link rel="stylesheet" href="https://unpkg.com/dropzone@5/dist/min/dropzone.min.css" type="text/css" />
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-Zenh87qX5JnK2Jl0vWa8Ck2rdkQ2Bzep5IDxbcnCeuOxjzrPF/et3URy9Bv1WTRi" crossorigin="anonymous">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-OERcA2EqjJCMA+/3y+gxIOqMEjwtxJY7qPCqsdltbNJuaOe923+mo//f6V8Qbsw3" crossorigin="anonymous"></script>
        <script src="https://unpkg.com/@popperjs/core@2"></script>
        <script src="https://cdn.jsdelivr.net/gh/cytoscape/cytoscape.js-popper@2.0.0/cytoscape-popper.js"></script> 
        <script async defer src="https://scripts.simpleanalyticscdn.com/latest.js"></script>
        <noscript><img src="https://queue.simpleanalyticscdn.com/noscript.gif" alt="" referrerpolicy="no-referrer-when-downgrade" /></noscript>



        <script src="https://unpkg.com/layout-base/layout-base.js"></script>
        <script src="https://unpkg.com/cose-base/cose-base.js"></script>
        <script src="https://unpkg.com/cytoscape-layout-utilities/cytoscape-layout-utilities.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/cytoscape-fcose@2.2.0/cytoscape-fcose.min.js"></script>

        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" crossorigin="" />
        <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" crossorigin=""></script>
        <script src="https://unpkg.com/cytoscape-leaflet@1.0.13/dist/cytoscape-leaflet.js"></script>
        
        
        <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.4/dist/jquery.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/jquery-csv@1.0.21/src/jquery.csv.min.js"></script>
        
        <script src="js/cytoscape-svg.js"></script>
        
        <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

        <!-- Local development  -->
        <!-- <script src="/js/cytoscape.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
        <script src="/js/dropzone.min.js"></script>
        <link rel="stylesheet" href="/css/dropzone.min.css" type="text/css" />
        <link href="/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
        <script src="/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script> -->

        <style>

            

                #graph > *:not(.leaflet-container) {
                    /* override default cytoscape styles */
                    z-index: 500 !important;
                }


            body {
                font-family: Roboto, "Open Sans", sans-serif;
                font-size: 20px;
                font-weight: 300;
                text-rendering: optimizeLegibility;
            }
            .btn {
                font-family: Roboto, "Open Sans", sans-serif;
                font-size: 18px;
                font-weight: 300;
                text-rendering: optimizeLegibility;
            }

            .dropzone {
                background: white;
                border-radius: 5px;
                border: 2px dashed rgb(0, 135, 247);
                border-image: none;
                margin-left: auto;
                margin-right: auto;
            }

            .popper-div {
                background-color: rgba(255, 255, 255, 0.716);
                border-radius: 25px;
                padding: 10px;
            }
        </style>
    </head>
    <body>
        <div id="alertPlaceholder"></div>
        <input type="color" id="colorPicker" style="display: none;">
        <div class="d-flex justify-content-center" style="height:100%;">
            <div class="p-2" style="overflow: auto; width:20%;">
                <img class="img-fluid mt-4 mb-4" src="img/tgv-logo.png" alt="">
                
                <p>
                    Add JSON transmission file:
                </p>
                <form action="/target" class="dropzone" id="json-drop" style="width:100%; height:20%;"></form>
                <hr>
                <!-- Checkbox to toggle tooltip -->
                <div class="p-2">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="" id="flexCheckDefault" onchange="toggle_checkbox()">
                        <label class="form-check-label" for="flexCheckDefault">
                          Toggle tooltip
                        </label>
                      </div>
                      
                </div>
                  
                
                
                <div class="p-2">
                    <label id="node_colour_label" class="form-check-label" for="node_colour" >
                        Node colour
                    </label>
                    <select id="node_colour" class="form-select" aria-label="Default select example">
                        <option selected></option>
                    </select>
                    <div class="pt-2" id="colour_legend"></div>
                </div>
                <div class="p-2">
                    <label id="node_symbol_label" class="form-check-label" for="node_symbol" >
                        Node symbol
                    </label>
                    <select id="node_symbol" class="form-select" aria-label="Default select example">
                        <option selected></option>
                    </select>
                    <div class="pt-2" id="shape_legend"></div>
                </div>
                <div class="p-2">
                    <label id="node_label_label" class="form-check-label" for="node_label" >
                        Node label
                    </label>
                    <select id="node_label" class="form-select" aria-label="Default select example">
                        <option selected></option>
                    </select>
                </div>
                <div class="p-2">
                    <label id="edge_label_label" class="form-check-label" for="edge_label" >
                        Edge label
                    </label>
                    <select id="edge_label" class="form-select" aria-label="Default select example">
                        <option selected></option>
                    </select>
                </div>
                <div class="p-2">
                    <label id="edge_width_label" class="form-check-label" for="edge_width" >
                        Edge Width
                    </label>
                    <select id="edge_width" class="form-select" aria-label="Default select example">
                        <option selected></option>
                    </select>
                </div>
                <div class="p-2">
                    <label id="edge_width_order_label" class="form-check-label" for="edge_width_order" >
                        Edge Width Order
                    </label>
                    <select id="edge_width_order" class="form-select" aria-label="Default select example">
                        <option selected>Increasing</option>
                        <option>Decreasing</option>
                    </select>
                </div>

                <!-- Button trigger modal -->
                <div class="p-2">
                    <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#exampleModal">
                        Filter edges
                    </button>
                </div>
                
                <!-- Modal -->
                <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                        <h1 class="modal-title fs-5" id="exampleModalLabel">Filter edges</h1>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="p-2">
                                <label id="edge_filter_key_label" class="form-check-label" for="edge_filter" >
                                    Edge filter attribute
                                </label>
                                <select id="edge_filter_key" class="form-select" aria-label="Default select example">
                                    <option selected></option>
                                </select>
                            </div>
            
              
            
                            <div class="p-2">
                                <label id="edge_filter_operator_label" class="form-check-label" for="edge_filter" >
                                    Edge Operator
                                </label>
                                <select id="edge_filter_operator" class="form-select" aria-label="Default select example">
                                    <option selected></option>
                                    <option>&lt;</option>
                                    <option>&gt;</option>
                                    <option>==</option>
                                    <option>!=</option>
                                </select>
                            </div>
                            <div class="p-2">
                                <label id="edge_filter_value_label" class="form-check-label" for="edge_filter" >
                                    Attribute value
                                </label>
                                <!-- <input id="edge_filter_value" class="input-group-text" aria-label="Default select example"> -->
                                <input type="text" class="form-control" id="edge_filter_value" >
                            </div>
                            <div class="p-2 ">
                                <button type="button" class="btn btn-outline-primary mt-2" onclick="add_edge_filter()">Add</button>
                            </div>
            
                            <div class="p-2">
                                <label class="form-check-label" for="active_edge_filters" >
                                    Active filters
                                </label>
                                <div class="" id="active_edge_filters"></div>
                            </div>
                            
                        </div>
                        <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                    </div>
                </div>





                <!-- Button trigger modal -->
                <div class="p-2">
                    <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#node_filter_modal">
                        Filter nodes
                    </button>
                </div>
                
                <!-- Modal -->
                <div class="modal fade" id="node_filter_modal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                        <h1 class="modal-title fs-5" id="exampleModalLabel">Filter nodes</h1>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="p-2">
                                <label id="node_filter_key_label" class="form-check-label" for="node_filter" >
                                    Node filter attribute
                                </label>
                                <select id="node_filter_key" class="form-select" aria-label="Default select example">
                                    <option selected></option>
                                </select>
                            </div>
            
              
            
                            <div class="p-2">
                                <label id="node_filter_operator_label" class="form-check-label" for="node_filter" >
                                    Node Operator
                                </label>
                                <select id="node_filter_operator" class="form-select" aria-label="Default select example">
                                    <option selected></option>
                                    <option>&lt;</option>
                                    <option>&gt;</option>
                                    <option>==</option>
                                    <option>!=</option>
                                </select>
                            </div>
                            <div class="p-2">
                                <label id="node_filter_value_label" class="form-check-label" for="node_filter" >
                                    Attribute value
                                </label>
                                <!-- <input id="node_filter_value" class="input-group-text" aria-label="Default select example"> -->
                                <input type="text" class="form-control" id="node_filter_value" >
                            </div>
                            <div class="p-2 ">
                                <button type="button" class="btn btn-outline-primary mt-2" onclick="add_node_filter()">Add</button>
                            </div>
            
                            <div class="p-2">
                                <label class="form-check-label" for="active_node_filters" >
                                    Active filters
                                </label>
                                <div class="" id="active_node_filters"></div>
                            </div>
                            
                        </div>
                        <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                    </div>
                </div>
  

                
                
                
                <div class="p-2 input-group">
                    <div>
                        <label id="max_dist_label" class="form-check-label" for="max_snp_dist" >
                            Search nodes
                        </label>
                    </div>
                    <div>
                        <input id="node_search" type="text" class="form-control" placeholder="" aria-label="Node search" aria-describedby="basic-addon2" oninput="node_search()">
                    </div>

                </div>
                
                <hr>
                <div class="p-2 ">
                    <button type="button" class="btn btn-outline-primary mt-2" onclick="download_sample_names()">Download selected IDs</button>
                    <button type="button" class="btn btn-outline-primary mt-2" onclick="download_png()">Download PNG</button>
                    <button type="button" class="btn btn-outline-primary mt-2" onclick="download_svg()">Download SVG</button>
                </div>
                <hr>

                <p>
                    Find more information on how to use this tool <a href="https://jodyphelan.github.io/tgv/info.html" target="_blank">here</a>.
                 </p>

            </div>
            <div id="info" class="p-5 align-self-center" style="max-width: 70%;">
                <div class="p-2 fs-3">
                    Welcome to the transmission graph viewer!
                </div>
                <div class="p-2">
                    Drag and drop your transmission graph json file to the upload box to 
                    the left and see the graph. You can also upload meta data in CSV format
                    to colour and label the nodes. Just make sure a column 'Node' is present 
                    which contains the same IDs as represented in the graph.
                    To for download the IDs from a subset, use the <kbd>cmd/ctrl</kbd> key and click and drag and hit the
                    download button.
                </div>
                <div class="p-2">
                    Don't have data yet? Download <a href="https://jodyphelan.github.io/tgv/examples/Moldova/moldova-tramsnission-network-large-clusters.json">this example json</a> 
                    file and drag it into the box on the top left:
                     
                </div>
                <div class="p-2">
                    No data is uploaded anywhere, all data is process and visualised in your browser
                    and stays on your computer. To show funders our software is used we do monitor 
                    the total number of page views, but no personal data is collected. This is facilitated through 
                    <a href="https://docs.simpleanalytics.com/what-we-collect" target="_blank">Simple Analytics</a>.
                </div>

                
                
                
            </div>
            <div class="p-2 flex-fill">
                <div id="cy" style="height:100%;"></div>
            </div>
            
        </div>

                
                


        <script>
            window.onload = function(){
                // document.getElementById("snp_dist_check").checked = false;
                // document.getElementById("sample_name_check").checked = false;
                // document.getElementById("flexRadioDefault1").checked = true;
            }

            function getRandomInt(max) {
               return Math.floor(Math.random() * max);
            }
            
            function mapNumRange(num, inMin, inMax, outMin, outMax) {
                return ((num - inMin) * (outMax - outMin)) / (inMax - inMin) + outMin;
            }

            var metadata_colours = []

            palletes =  {
                1:["#000000"],
                2:["#1b9e77","#7570b3"],
                3:['#1B9E77', '#D95F02', '#7570B3'],
                4:['#1B9E77', '#D95F02', '#7570B3', '#E7298A'],
                5:['#1B9E77', '#D95F02', '#7570B3', '#E7298A', '#66A61E'],
                6:['#1B9E77', '#D95F02', '#7570B3', '#E7298A', '#66A61E', '#E6AB02'],
                7:['#1B9E77', '#D95F02', '#7570B3', '#E7298A', '#66A61E', '#E6AB02', '#A6761D'],
                8:['#1B9E77', '#D95F02', '#7570B3', '#E7298A', '#66A61E', '#E6AB02', '#A6761D', '#666666'],
                9:['#A6CEE3', '#1F78B4', '#B2DF8A', '#33A02C', '#FB9A99', '#E31A1C', '#FDBF6F', '#FF7F00', '#CAB2D6'],
                10:['#A6CEE3', '#1F78B4', '#B2DF8A', '#33A02C', '#FB9A99', '#E31A1C', '#FDBF6F', '#FF7F00', '#CAB2D6', '#6A3D9A'],
                11:['#A6CEE3', '#1F78B4', '#B2DF8A', '#33A02C', '#FB9A99', '#E31A1C', '#FDBF6F', '#FF7F00', '#CAB2D6', '#6A3D9A', '#FFFF99'],
                12:['#A6CEE3', '#1F78B4', '#B2DF8A', '#33A02C', '#FB9A99', '#E31A1C', '#FDBF6F', '#FF7F00', '#CAB2D6', '#6A3D9A', '#FFFF99', '#B15928']
            }

            symbol_palletes = {
                1: ["ellipse"],
                2: ["ellipse","triangle"], 
                3: ["ellipse","triangle","rectangle"],
                4: ["ellipse","triangle","rectangle","pentagon"],
                5: ["ellipse","triangle","rectangle","pentagon","diamond"],
                6: ["ellipse","triangle","rectangle","pentagon","diamond","star"],

            }


            symbol_html = {
                "ellipse": "&#9679;",
                "triangle": "&#9650;",
                "rectangle": "&#9632;",
                "pentagon": "&#11039;",
                "diamond": "&#9670;",
                "star": "&#9733;",
            }
            
            var cy;
            var data;
            var cymap = undefined;

            var edge_filters = [];
            var node_filters = [];

            var tooltip_enabled = false;

            toggle_checkbox = function(){
                tooltip_enabled = !tooltip_enabled
            }

            get_node_metadata = function(data){
                dict = {}
                data.forEach(function(d){
                    if (d.data.type=="node"){
                        for (label in d.data){
                            if (label!="type" ){
                                if (!(label in dict)){
                                    dict[label] = [d.data[label]]
                                } else {
                                    dict[label].push(d.data[label])
                                }
                            }
                        }
                    }
                })
                uniqified_dict = {}
                for (label in dict){
                    uniqified_dict[label] = [...new Set(dict[label])]
                }
                return uniqified_dict
            }

            get_edge_metadata = function(data){
                dict = {}
                data.forEach(function(d){
                    if (d.data.type=="edge"){
                        for (label in d.data){
                            if (label!="type" && label!="id" && label!="source" && label!="target"){
                                if (!(label in dict)){
                                    dict[label] = [d.data[label]]
                                } else {
                                    dict[label].push(d.data[label])
                                }
                            }
                        }
                    }
                })
                uniqified_dict = {}
                for (label in dict){
                    uniqified_dict[label] = [...new Set(dict[label])]
                }
                return uniqified_dict
            }
            populate_edge_label_options = function(data){
                edge_metadata = get_edge_metadata(data);
                edge_labels = document.getElementById("edge_filter_key")
                edge_labels.innerHTML = ""
                edge_labels.innerHTML += '<option selected></option>'
                for (label in edge_metadata){
                    edge_labels.innerHTML += '<option value="'+label+'">'+label+'</option>'
                }
                edge_labels = document.getElementById("edge_label")
                edge_labels.innerHTML = ""
                edge_labels.innerHTML += '<option selected></option>'
                for (label in edge_metadata){
                    edge_labels.innerHTML += '<option value="'+label+'">'+label+'</option>'
                }
                edge_widths = document.getElementById("edge_width")
                edge_widths.innerHTML = ""
                edge_widths.innerHTML += '<option selected></option>'
                for (label in edge_metadata){
                    edge_widths.innerHTML += '<option value="'+label+'">'+label+'</option>'
                }
            }

            



            draw_edge_labels = function(){
                console.log("Redrawing edge labels")
                edge_labels = document.getElementById("edge_label")
                if (edge_labels.value==""){
                        cy.edges().style("label","")
                    } else {
                        cy.edges().style("label",function(d){
                            return d.data()[edge_labels.value]
                        })
                    }
                
            }

            
            add_edge_label_listener = function(data){
                console.log("Adding label to edges")
                edge_labels.onchange = function(){
                    draw_edge_labels()
                }
            }

            get_edge_width_function = function(){
                variable = document.getElementById("edge_width").value
                minval = Math.min(...cy.edges().map(function(x){return x.data()[variable]}))
                maxval = Math.max(...cy.edges().map(function(x){return x.data()[variable]}))

                
                if (document.getElementById("edge_width_order").value=="Increasing"){
                    maxmapped = 20
                    minmapped = 1
                } else {
                    maxmapped = 1
                    minmapped = 20
                }

                return function(d){
                    return mapNumRange(d.data()[variable],minval,maxval,minmapped,maxmapped)
                }
            }
            
            draw_edge_width = function(){
                console.log("Redrawing edge width")
                edge_width = document.getElementById("edge_width")
                if (edge_width.value==""){
                        cy.edges().style("width",3) 
                    } else {
                        f = get_edge_width_function()
                        cy.edges().style("width",f)
                    }
            }

            add_edge_width_listener = function(data){
                edge_width = document.getElementById("edge_width")
                edge_width.onchange = function(){
                    draw_edge_width()
                }
                edge_width_order = document.getElementById("edge_width_order")
                edge_width_order.onchange = function(){
                    draw_edge_width()
                }
            }

            get_pallete = function(arr){
                cols = {}
                if (arr.length>12){
                    for (i in arr){
                        cols[arr[i]] = "black"
                    } 
                } else {

                    pal = palletes[arr.length]
                    for (i in arr){
                        cols[arr[i]] = pal[i]
                    }
                }
                
                return cols
            }

            get_symbol_pallete = function(arr){
                var symbols = {}
                if (arr.length>6){
                    for (i in arr){
                        symbols[arr[i]] = "ellipse"
                    } 
                } else {

                    pal = symbol_palletes[arr.length]
                    for (i in arr){
                        symbols[arr[i]] = pal[i]
                    }
                }
                
                return symbols
            }

            get_metadata_colours = function(data){
                metadata = get_node_metadata(data)
                colours = {}
                for (label in metadata){
                    colours[label] = get_pallete(metadata[label])
                }
                return colours
            }

            get_metadata_symbols = function(data){
                metadata = get_node_metadata(data)
                symbols = {}
                for (label in metadata){
                    symbols[label] = get_symbol_pallete(metadata[label])
                }
                return symbols
            }

            populate_select_with_options = function(id,metadata,options = []){
                el = document.getElementById(id)
                el.innerHTML = ""
                el.innerHTML += '<option selected></option>'
                for (label in metadata){
                    el.innerHTML += '<option value="'+label+'">'+label+'</option>'
                }
                for (option in options){
                    el.innerHTML += '<option value="'+options[option]+'">'+options[option]+'</option>'
                }
            }
            populate_node_selects = function(data){
                metadata_colours = get_metadata_colours(data)
                populate_select_with_options("node_label",metadata_colours)
                populate_select_with_options("node_symbol",metadata_colours)
                populate_select_with_options("node_colour",metadata_colours)
                populate_select_with_options("node_filter_key",metadata_colours,["degree"])
            }

            colour_nodes = function(){
                node_colours = document.getElementById("node_colour")
                if (node_colours.value==""){
                        cy.nodes().style("background-color","#000000")
                } else {
                    cy.nodes().style("background-color",function(d){
                        return metadata_colours[node_colours.value][d.data()[node_colours.value]]
                    })
                }
                div = document.getElementById("colour_legend");
                div.innerHTML = "";
                if (node_colours.value!=""){
                    if (Object.keys(metadata_colours[node_colours.value]).length<=12){ 
                        for (var key in metadata_colours[node_colours.value]) {
                            div.innerHTML += "<span class='badge m-1' style='background-color:"+metadata_colours[node_colours.value][key]+"' onclick='launchColorPicker(this)'>"+key+"</span>"
                        }
                    } else {
                        div.innerHTML = "<span class='badge m-1' style='background-color:black'>Too many colours to display</span>"
                    }
                }
            }
            add_node_colour_listener = function(data){
                // metadata_colours = get_metadata_colours(data)
                node_colours = document.getElementById("node_colour")
                node_colours.onchange = function(){
                    console.log(metadata_colours)
                    colour_nodes()
                }
                
            }

            launchColorPicker = function(targetElement){

                var watchColorPicker = function(event) {
                    metadata_colours[document.getElementById("node_colour").value][targetElement.innerHTML] = event.target.value
                    colour_nodes()
                }

                var old_element = document.getElementById("colorPicker");
                var new_element = old_element.cloneNode(true);
                old_element.parentNode.replaceChild(new_element, old_element);
                var colorPicker = document.getElementById("colorPicker")
                colorPicker.addEventListener("change", watchColorPicker, false);
                colorPicker.value = metadata_colours[document.getElementById("node_colour").value][targetElement.innerHTML]
                colorPicker.click();
            }

            set_node_symbols = function(){
                console.log("Setting node symbols")
                node_symbols = document.getElementById("node_symbol")
                if (node_symbols.value==""){
                        cy.nodes().style("shape","ellipse")
                    } else {
                        cy.nodes().style("shape",function(d){
                            return metadata_symbols[node_symbols.value][d.data()[node_symbols.value]]
                        })
                    }
                    div = document.getElementById("shape_legend");
                    div.innerHTML = "";
                    if (Object.keys(metadata_symbols[node_symbols.value]).length<=6){ 
                        for (var key in metadata_symbols[node_symbols.value]) {
                            div.innerHTML += "<span class='badge m-1' style='background-color:black'>"+symbol_html[metadata_symbols[node_symbols.value][key]]+" "+key+"</span>"
                        }
                    } else {
                        div.innerHTML = "<span class='badge m-1' style='background-color:black'>Too many symbols to display</span>"
                    }
            }

            add_node_symbol_listener = function(data){
                metadata_symbols = get_metadata_symbols(data)
                node_symbols = document.getElementById("node_symbol")
                node_symbols.onchange = function(){
                    set_node_symbols()
                }
                
            }

            add_node_label_listener = function(data){
                // metadata_colours = get_metadata_colours(data)
                node_labels = document.getElementById("node_label")
                console.log("Adding label to edges")
                node_labels.onchange = function(){
                    if (node_labels.value==""){
                        cy.nodes().style("label","")
                    } else {
                        cy.nodes().style("label",function(d){
                            return d.data()[node_labels.value]
                        })
                    }
                }
            }

            add_edge_filter = function(){
                key = document.getElementById("edge_filter_key").value
                operator = document.getElementById("edge_filter_operator").value
                value = document.getElementById("edge_filter_value").value
                fid = Date.now()
                edge_filters.push({key: key, operator: operator, val: value, id: fid});
                console.log(edge_filters)
                var el = document.createElement('span');
                el.id = fid
                el.classList.add('badge')
                el.classList.add('text-bg-dark')
                el.style = 'cursor: not-allowed;'
                el.innerHTML = key + operator + value
                el.onclick = function() {remove_edge_filter(this)}
                document.getElementById('active_edge_filters').appendChild(el)

                redraw_graph()
            }

            add_node_filter = function(){
                key = document.getElementById("node_filter_key").value
                operator = document.getElementById("node_filter_operator").value
                value = document.getElementById("node_filter_value").value
                fid = Date.now()
                node_filters.push({key: key, operator: operator, val: value, id: fid});
                console.log(node_filters)
                var el = document.createElement('span');
                el.id = fid
                el.classList.add('badge')
                el.classList.add('text-bg-dark')
                el.style = 'cursor: not-allowed;'
                el.innerHTML = key + operator + value
                el.onclick = function() {remove_node_filter(this)}
                document.getElementById('active_node_filters').appendChild(el)

                redraw_graph()
            }

            remove_edge_filter = function(t){
                edge_filters = edge_filters.filter(function(x){return x.id!=t.id})
                t.remove()
                redraw_graph()
                colour_nodes()
                set_node_symbols()
            }

            remove_node_filter = function(t){
                node_filters = node_filters.filter(function(x){return x.id!=t.id})
                t.remove()
                redraw_graph()
                colour_nodes()
                set_node_symbols()
            }

            redraw_graph = function(){
                console.log("Redrawing graph")
                console.log(edge_filters)
                console.log(node_filters)
                newdata = data.filter(function(x){
                    if (x.data.type=="node"){
                        return true
                    } else {
                        test = true
                        edge_filters.forEach(function(f){
                            if (f.operator=="<"){
                                if (! (x.data[f.key] < parseFloat(f.val))){
                                    test = false
                                }
                            }
                            if (f.operator==">"){
                                if (! (x.data[f.key] > parseFloat(f.val))){
                                    test = false
                                }
                            }
                            if (f.operator=="=="){
                                if (! (x.data[f.key] == f.val)){
                                    test = false
                                }
                            }
                            if (f.operator=="!="){
                                if (! (x.data[f.key] != f.val)){
                                    test = false
                                }
                            }
                        })
                        return test
                    }
                })
                cy.json({ elements: newdata });

                newdata = newdata.filter(function(x){
                    if (x.data.type=="node"){
                        test = true
                        node_filters.forEach(function(f){
                            if (f.key=='degree'){
                                x.data.degree = cy.$('#'+x.data.id).degree()
                            }
                            if (f.operator=="<"){
                                if (! (x.data[f.key] < parseFloat(f.val))){
                                    test = false
                                }
                            }
                            if (f.operator==">"){
                                if (! (x.data[f.key] > parseFloat(f.val))){
                                    test = false
                                }
                            }
                            if (f.operator=="=="){
                                if (! (x.data[f.key] == f.val)){
                                    test = false
                                }
                            }
                            if (f.operator=="!="){
                                if (! (x.data[f.key] != f.val)){
                                    test = false
                                }
                            }
                        })
                        return test
                    } else {
                        return true
                    }
                })

                
                
                cy.json({ elements: newdata });
                if (!cymap){
                    

                    cy.ready(function () {
                        var layout = cy.layout(
                            { 
                                name: 'fcose' ,
                                idealEdgeLength: function(edge){
                                    min_degree = Math.min(edge.source().degree(),edge.target().degree())
                                    return mapNumRange(min_degree,0,10,50,200)
                                },
                            }
                        ); 
                        layout.run();
                    });
                    draw_edge_labels(data)
                } else {
                    destroy_map()
                    draw_map(cy)
                }
                add_interaction_listener()
            }

            reset_view = function(){
                div = document.getElementById("colour_legend");
                div.innerHTML = ""; 
                div = document.getElementById("shape_legend");
                div.innerHTML = ""; 
                
            }

            populate_dropdowns = function(data){
                reset_view()
                populate_node_selects(data);
                add_node_colour_listener(data);
                add_node_symbol_listener(data);
                add_node_label_listener(data);
                populate_edge_label_options(data);
                add_edge_label_listener(data);
                add_edge_width_listener(data);
            }

            add_interaction_listener = function(){

                cy.on('boxselect',function(x){
                    cy.nodes(':selected').forEach(function(ele){
                        ele.style("border-color","red")
                    })
                })

                cy.on('click',function(x){
                    cy.nodes(':selected').forEach(function(ele){
                        ele.style("border-color","red")
                    })
                })

                cy.on('tapunselect',function(ele){
                    cy.nodes().forEach(function(ele){
                        ele.style("border-color","black")
                    })
                })

                cy.nodes().on('mouseover', function(x){
                    ele = x.target
                    ele.popper({
                        content: function(x){ return generate_tooltip(ele)}
                    })
                })

                cy.nodes().on('mouseout', function(x){
                    document.getElementsByClassName('popper-div').forEach(function(x){
                        x.remove()
                    })
                })

                cy.edges().on('mouseover', function(x){
                    ele = x.target
                    ele.popper({
                        content: function(x){ return generate_tooltip(ele)}
                    })
                })

                cy.edges().on('mouseout', function(x){
                    document.getElementsByClassName('popper-div').forEach(function(x){
                        x.remove()
                    })
                })


                // document.getElementById('mode').addEventListener('click', function(){toggleMap(cy)});

                
                var generate_tooltip = function(ele){
                    if (!tooltip_enabled){
                        return
                    }

                    document.getElementsByClassName('popper-div').forEach(function(x){
                        x.remove()
                    })
                    var div = document.createElement('div');
                    div.classList.add('popper-div');
                    div.innerHTML = "<b>ID:</b> " + ele.data('id')
                    for (key in ele.data()){
                        if (key=="id"){continue}
                        // if (key=="type"){continue}
                        div.innerHTML = div.innerHTML + "<br>" + "<b>"+key+":</b> "+ele.data(key)
                    }
                    document.body.appendChild( div );
                    return div;
                };
            }

            destroy_map = function(){
                if (cymap){
                    cymap.destroy();
                    cymap = undefined;
                }
            }

            draw_map = function(cy){
                cy.container().setAttribute("id", "graph");
                cymap = cy.L({
                minZoom: 0,
                maxZoom: 18,
                }, {
                getPosition: (node) => {
                    const lng = node.data('lng');
                    const lat = node.data('lat');
                    return typeof lng === "number" && typeof lat === "number"
                    ? { lat, lng }
                    : null;
                },
                setPosition: (node, lngLat) => {
                    node.data('lng', lngLat.lng);
                    node.data('lat', lngLat.lat);
                    console.log(node.id(), lngLat);
                },
                animate: true,
                animationDuration: 500,
                });
                window.cymap = cymap;
                L.tileLayer('//{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                minZoom: 0,
                maxZoom: 18,
                }).addTo(cymap.map);
                console.log("aosdkaosdkj")
                cymap.map.setView([55.10351605801967,11.42],5)
            }

            toggleMap = function(cy){
                if (!cymap) {
                    draw_map(cy);
                } else {
                    destroy_map();
                }
            };
            
            download_sample_names = function() {
                var element = document.createElement('a');
                text = ""
                cy.nodes(':selected').map(function(x){return x.data('id')}).forEach(function(x){text += x + "\n"})
                element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
                element.setAttribute('download', "sample_names.txt");

                element.style.display = 'none';
                document.body.appendChild(element);

                element.click();

                document.body.removeChild(element);
            }

            download_png = function() {
                var element = document.createElement('a');
                element.setAttribute('href', cy.png({scale:3,bg:"white"}));
                element.setAttribute('download', "graph.png");

                element.style.display = 'none';
                document.body.appendChild(element);

                element.click();

                document.body.removeChild(element);
            }

            download_svg = function() {
                var svgContent = cy.svg({scale: 1, full: true, bg: '#ffffff'});
                console.log(svgContent)
                // var blob = new Blob([svgContent], {type: "image/svg+xml"});
                // saveAs(blob, "graph.svg");


                        // svgContent is your original SVG string
                const div = document.createElement('div');
                div.innerHTML = svgContent;

                const svg = div.querySelector('svg');

                // Your legend object
                const legend = metadata_colours[node_colours.value] || {};

                // --- 1. Adjust SVG height ---
                const currentHeight = parseFloat(svg.getAttribute('height')) || 0;
                const legendItemHeight = 30;
                const legendHeight = Object.keys(legend).length * legendItemHeight;
                svg.setAttribute('height', currentHeight + legendHeight);

                // --- 2. Shift existing content down ---
                const firstG = svg.querySelector('g');
                if (firstG) {
                const currentTransform = firstG.getAttribute('transform') || '';
                const newTransform = `translate(0, ${legendHeight}) ${currentTransform}`.trim();
                firstG.setAttribute('transform', newTransform);
                }

                // --- 3. Build the legend ---
                const legendGroup = document.createElementNS("http://www.w3.org/2000/svg", "g");

                let index = 0;
                for (const [label, color] of Object.entries(legend)) {
                const yOffset = index * legendItemHeight + 5;

                // Rectangle (left)
                const rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                rect.setAttribute("x", "10");
                rect.setAttribute("y", yOffset);
                rect.setAttribute("width", "20");
                rect.setAttribute("height", "20");
                rect.setAttribute("fill", color);
                rect.setAttribute("stroke", "black");
                rect.setAttribute("stroke-width", "2");

                // Text (right of the rectangle)
                const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
                text.setAttribute("x", "40"); // 10 (padding) + 20 (rect width) + 10
                text.setAttribute("y", yOffset + 16); // align with rect vertically
                text.setAttribute("font-family", "Helvetica Neue, Helvetica, sans-serif");
                text.setAttribute("font-size", "16px");
                text.setAttribute("font-style", "normal");
                text.setAttribute("fill", "black");
                text.textContent = label;

                legendGroup.appendChild(rect);
                legendGroup.appendChild(text);

                index++;
                }

                // --- 4. Insert the legend before the first group ---
                svg.insertBefore(legendGroup, firstG);

                // --- 5. Create a blob and download ---
                const blob = new Blob([div.innerHTML], { type: "image/svg+xml" });
                saveAs(blob, "test.graph.svg");

            }


            parse_json = function(event){
                const element = document.getElementById('info');
                if (element!=null){

                    element.remove();
                }
                raw_data = JSON.parse(event.target.result);
                directional = raw_data.directed
                data = [];
                raw_data.nodes.forEach(function(x){
                    obj = {
                        data: {
                            id: x.id,
                            type: 'node'
                        }
                    }
                    for (key in x.properties){
                        obj.data[key] = x.properties[key]
                    }
                    data.push(obj)
                })
                raw_data.edges.forEach(function(x){
                    obj = {
                        data: {
                            id: x.id,
                            source: x.source,
                            target: x.target,
                            type: 'edge'
                        }
                    }
                    for (key in x.properties){
                        obj.data[key] = x.properties[key]
                    }
                    data.push(obj)
                })
                
                populate_dropdowns(data)
                

                

                node_search = function(){
                    search_term = document.getElementById("node_search").value
                    obj = cy.$id(search_term)
                    if (obj.length > 0){
                        cy.fit(obj,200)
                    }
                }
                console.log(data)
                cy = cytoscape({

                    container: document.getElementById('cy'), // container to render in

                    elements: data,


                    style: [ // the stylesheet for the graph
                        {
                            selector: 'node',
                            style: {
                            'background-color': function(n){
                                return n.data().id.startsWith('compound') ? '#e3e3e3' : '#000'
                            },
                            'border-width': 2,
                            }
                        },

                        {
                            selector: 'edge',
                            style: {
                            'width': 3,
                            'line-color': '#ccc',
                            'target-arrow-shape': directional ? 'triangle' : 'none',
                            'curve-style': directional ? 'bezier' : 'haystack',
                            }
                        }
                    ],

                    layout: {
                        name: 'fcose',
                        idealEdgeLength: function(edge){
                            min_degree = Math.min(edge.source().degree(),edge.target().degree())
                            return mapNumRange(min_degree,0,10,50,200)
                            
                        },
                    },
                    hideEdgesOnViewport: true,
                    boxSelectionEnabled:true

                });

                add_interaction_listener()
            }

            parse_node_csv = function(event){
                var text = event.target.result
                rows = $.csv.toObjects(text)

                lookup = {}
                rows.forEach(function(row){
                    lookup[row.Node] = row
                })

                data.forEach(function(d){
                    if (lookup[d.data.id]){
                        for (key in lookup[d.data.id]){
                            d.data[key] = lookup[d.data.id][key]
                        }
                    }
                })

                
                populate_dropdowns(data)
                alert('Sucessfully added metadata to nodes.', 'success','liveAlertPlaceholderNodes')
            }

            parse_edge_csv = function(event){
                var text = event.target.result
                console.log(text)
                rows = $.csv.toObjects(text)

                lookup = {}
                rows.forEach(function(row){
                    lookup[row['Source']+row['Target']] = row
                })

                data.forEach(function(d){
                    if (lookup[d.data.source+d.data.target]){
                        for (key in lookup[d.data.source+d.data.target]){
                            d.data[key] = lookup[d.data.source+d.data.target][key]
                        }
                    }
                })

            

                
                populate_dropdowns(data)
                alert('Sucessfully added metadata to edges.', 'success', 'liveAlertPlaceholderEdges')
            }

            Dropzone.options.jsonDrop = { // camelized version of the `id`
                paramName: "file", // The name that will be used to transfer the file
                maxFilesize: 20, // Mb
                previewsContainer: false,
                accept: function(file, done) {
                    var reader = new FileReader();
                    reader.addEventListener("loadend", function(event) { 
                        console.log(event)
                        if (event.target.result.startsWith('Node')){
                            parse_node_csv(event)
                        } else if (event.target.result.startsWith('Source')){
                            parse_edge_csv(event)
                        } else if (event.target.result.replace(/\s/g, "").startsWith('{"nodes"')) {
                            parse_json(event)
                        } else {
                            alert('File not recognised. Please upload a json file or a csv file with a column "Node" for nodes or columns "Source" and "Target" for edges.', 'danger')
                        }
                    });
                    reader.readAsText(file);
                    console.log(file)

                }
            };

            Dropzone.options.nodeDataDrop = { // camelized version of the `id`
                paramName: "file", // The name that will be used to transfer the file
                maxFilesize: 10, // Mb
                previewsContainer: false,
                accept: function(file, done) {
                    var reader = new FileReader();
                    reader.addEventListener("loadend", function(event) { 
                        
                    });
                    reader.readAsText(file);
                }
            };

            Dropzone.options.edgeDataDrop = { // camelized version of the `id`
                paramName: "file", // The name that will be used to transfer the file
                maxFilesize: 100, // Mb
                previewsContainer: false,
                accept: function(file, done) {
                    var reader = new FileReader();
                    reader.addEventListener("loadend", function(event) { 
                        
                    });
                    reader.readAsText(file);
                }
            };


            

            const alert = (message, type) => {
                placeholder = document.getElementById('alertPlaceholder')
                placeholder.innerHTML = ""
                const wrapper = document.createElement('div')
                wrapper.innerHTML = [
                    `<div class="modal fade" id="alertModel" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">`,
                    `    <div class="modal-dialog">`,
                    `        <div class="modal-content alert alert-${type}">`,
                    '            <div class="modal-header">',
                    '                <h5 class="modal-title" id="exampleModalLabel"></h5>',
                    '                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>',
                    '            </div>',
                    `            <div class="modal-body">${message}  </div>`,
                    '        </div>',
                    '    </div>',
                    '</div>'
                ].join('')

                placeholder.append(wrapper)
                $('#alertModel').modal('show');
            }
            
        </script>
    </body>
</html>
